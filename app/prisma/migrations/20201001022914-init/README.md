# Migration `20201001022914-init`

This migration has been generated by Ankur Sundara at 9/30/2020, 10:29:14 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "User" (
    "id" INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    "shibId" TEXT NOT NULL,
    "discordId" TEXT NOT NULL,
    "shibAffiliations" TEXT NOT NULL,
    "discordServerId" TEXT NOT NULL,

    FOREIGN KEY ("discordServerId") REFERENCES "DiscordServer"("id") ON DELETE CASCADE ON UPDATE CASCADE
)

CREATE TABLE "DiscordServer" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL DEFAULT 'temp name',
    "description" TEXT NOT NULL DEFAULT 'temp description',
    "allowlistEnabled" BOOLEAN NOT NULL DEFAULT false,
    "authRole" TEXT,
    "loggingChannelId" TEXT,
PRIMARY KEY ("id")
)

CREATE TABLE "AffiliationToRoleMapping" (
    "shibAffiliation" TEXT NOT NULL,
    "discordRole" TEXT NOT NULL,
    "discordServerId" TEXT NOT NULL,

    FOREIGN KEY ("discordServerId") REFERENCES "DiscordServer"("id") ON DELETE CASCADE ON UPDATE CASCADE,
PRIMARY KEY ("shibAffiliation","discordServerId")
)
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201001022914-init
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,50 @@
+// This is your Prisma schema file,
+// learn more about it in the docs: https://pris.ly/d/prisma-schema
+
+datasource db {
+  provider = "sqlite"
+  url = "***"
+}
+
+generator client {
+  provider = "prisma-client-js"
+}
+
+model User {
+  id               Int @id @default(autoincrement())
+  shibId           String
+  discordId        String
+  shibAffiliations String
+  server           DiscordServer @relation(references: [id]) // server that they are part of
+}
+
+model DiscordServer {
+  // discord guild id
+  id               String @id
+  name             String @default("temp name")
+  description      String @default("temp description")
+  // whether to use the allowlist
+  allowlistEnabled Boolean @default(false)
+  // list of allowed shibIds
+  //allowlist        String[] 
+  // list of discord user ids of managers
+  //managers         String[] 
+  // list of all authenticated users
+  users            User[]
+  // roleId to give all authenticated users
+  authRole         String?
+  // affiliation -> roleId mappings
+  roleMappings     AffiliationToRoleMapping[] 
+  // channel id to dump logs in
+  loggingChannelId String?
+}
+
+model AffiliationToRoleMapping {
+  //id               Int @id @default(autoincrement())
+  shibAffiliation  String
+  discordRole      String
+  discordServer    DiscordServer @relation(fields: [discordServerId], references: [id])
+  discordServerId  String
+
+  @@id([shibAffiliation, discordServerId])
+}
```


